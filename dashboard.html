<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¥®é£Ÿè¿½è¸ªå™¨ - ä»Šæ—¥ä»ªè¡¨ç›˜</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .navbar {
            background-color: #4ECDC4;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-links a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #4ECDC4;
            padding-bottom: 8px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .nutrient-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .progress-bar {
            height: 25px;
            background-color: #e0e0e0;
            border-radius: 12px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 12px;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .carb-fill { background-color: #4ECDC4; }
        .protein-fill { background-color: #45B7AF; }
        .fat-fill { background-color: #3CA299; }
        .over-fill { background-color: #FF6B6B; }
        
        .nutrient-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .records-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        .record-food {
            font-weight: 500;
        }
        
        .record-nutrients {
            color: #666;
            font-size: 0.9rem;
        }
        
        .record-time {
            color: #999;
            font-size: 0.8rem;
        }
        
        .delete-btn {
            color: #FF6B6B;
            text-decoration: none;
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 3px;
            border: 1px solid #FF6B6B;
            transition: all 0.3s;
        }
        
        .delete-btn:hover {
            background-color: #FF6B6B;
            color: white;
        }
        
        .btn {
            display: inline-block;
            background-color: #4ECDC4;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #3CA299;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .flash-messages {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .chart-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .chart-container img {
            max-width: 100%;
            border-radius: 8px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">ğŸ½ï¸ é¥®é£Ÿè¿½è¸ªå™¨</div>
        <div class="nav-links">
            <a href="/">ä»Šæ—¥ä»ªè¡¨ç›˜</a>
            <a href="/add_record">æ·»åŠ è®°å½•</a>
            <a href="/templates">é£Ÿç‰©æ¨¡æ¿</a>
            <a href="/history">å†å²è®°å½•</a>
            <a href="/config">ä¸ªäººè®¾ç½®</a>
        </div>
    </nav>
    
    <!-- é—ªå­˜æ¶ˆæ¯ -->
    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'error' else 'error' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    
    <!-- ä¸»æ ‡é¢˜ -->
    <h1 style="margin-bottom: 20px; color: #333;">ä»Šæ—¥æ‘„å…¥æƒ…å†µ - {{ today.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</h1>
    
    <!-- è¿›åº¦å›¾è¡¨ -->
    {% if chart_url %}
    <div class="card">
        <div class="card-title">è¥å…»ç´ æ‘„å…¥è¿›åº¦</div>
        <div class="chart-container">
            <img src="data:image/png;base64,{{ chart_url }}" alt="è¥å…»ç´ æ‘„å…¥è¿›åº¦å›¾è¡¨">
        </div>
    </div>
    {% endif %}
    
    <!-- è¥å…»ç´ ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
        {% for nutrient, data in progress.items() %}
        <div class="stat-card">
            <div class="nutrient-name">
                {% if nutrient == 'carb' %}ç¢³æ°´åŒ–åˆç‰©
                {% elif nutrient == 'protein' %}è›‹ç™½è´¨
                {% elif nutrient == 'fat' %}è„‚è‚ª{% endif %}
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill {{ nutrient }}-fill {% if data.is_over %}over-fill{% endif %}" 
                     style="width: {% if data.percentage > 100 %}100{% else %}{{ data.percentage }}{% endif %}%;">
                    <div class="progress-text">{{ "%.1f"|format(data.percentage) }}%</div>
                </div>
            </div>
            
            <div class="nutrient-info">
                <div>å·²æ‘„å…¥: {{ "%.1f"|format(data.consumed) }}g</div>
                <div>ç›®æ ‡: {{ "%.1f"|format(data.goal) }}g</div>
                <div>
                    {% if data.remaining > 0 %}
                    å‰©ä½™: {{ "%.1f"|format(data.remaining) }}g
                    {% else %}
                    è¶…æ ‡: {{ "%.1f"|format(-data.remaining) }}g
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- å¿«é€Ÿæ·»åŠ è®°å½• -->
    <div class="card">
        <div class="card-title">å¿«é€Ÿæ·»åŠ è®°å½•</div>
        <form action="/add_record" method="post" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div class="form-group">
                <label class="form-label">é€‰æ‹©æ¨¡æ¿</label>
                <select name="template_id" class="form-input" onchange="loadTemplate(this)">
                    <option value="custom">è‡ªå®šä¹‰...</option>
                    {% for template in templates %}
                    <option value="{{ template.id }}">{{ template.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">é£Ÿç‰©åç§°</label>
                <input type="text" name="food_name" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">é‡é‡(g)</label>
                <input type="number" name="weight" class="form-input" step="0.1" min="0" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ—¶é—´</label>
                <input type="time" name="time" class="form-input" value="{{ now.strftime('%H:%M') if now else '12:00' }}">
            </div>
            
            <div class="form-group" id="custom-fields" style="display: none; grid-column: 1 / -1;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div>
                        <label class="form-label">ç¢³æ°´æ¯”ä¾‹(%)</label>
                        <input type="number" name="carb_ratio" class="form-input" step="0.1" min="0" max="100" value="40">
                    </div>
                    <div>
                        <label class="form-label">è›‹ç™½è´¨æ¯”ä¾‹(%)</label>
                        <input type="number" name="protein_ratio" class="form-input" step="0.1" min="0" max="100" value="20">
                    </div>
                    <div>
                        <label class="form-label">è„‚è‚ªæ¯”ä¾‹(%)</label>
                        <input type="number" name="fat_ratio" class="form-input" step="0.1" min="0" max="100" value="10">
                    </div>
                </div>
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label">å¤‡æ³¨(å¯é€‰)</label>
                <input type="text" name="notes" class="form-input" placeholder="ä¾‹å¦‚ï¼šåˆé¤ï¼ŒåŠ äº†é¸¡è›‹">
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <button type="submit" class="btn">æ·»åŠ è®°å½•</button>
            </div>
        </form>
    </div>
    
    <!-- ä»Šæ—¥è®°å½•åˆ—è¡¨ -->
    <div class="card">
        <div class="card-title">ä»Šæ—¥è®°å½• ({{ records|length }}æ¡)</div>
        
        {% if records %}
        <div class="records-list">
            {% for record in records %}
            <div class="record-item">
                <div>
                    <div class="record-food">{{ record.food_name }} ({{ record.weight }}g)</div>
                    <div class="record-nutrients">
                        ç¢³æ°´{{ record.carb_ratio }}% | è›‹ç™½{{ record.protein_ratio }}% | è„‚è‚ª{{ record.fat_ratio }}%
                    </div>
                    <div class="record-time">{{ record.time.strftime('%H:%M') }}</div>
                </div>
                <div>
                    <a href="/delete_record/{{ record.id }}" class="delete-btn" 
                       onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')">åˆ é™¤</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•å“¦ï½</p>
            <p>ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ è®°å½•"å¼€å§‹è®°å½•ä½ çš„ç¬¬ä¸€é¤å§ï¼</p>
        </div>
        {% endif %}
    </div>
    
    <script>
        // æ¨¡æ¿é€‰æ‹©åŠŸèƒ½
        const templateData = {
            {% for template in templates %}
            "{{ template.id }}": {
                name: "{{ template.name }}",
                carb_ratio: {{ template.carb_ratio }},
                protein_ratio: {{ template.protein_ratio }},
                fat_ratio: {{ template.fat_ratio }}
            },
            {% endfor %}
        };
        
        function loadTemplate(selectElement) {
            const templateId = selectElement.value;
            const customFields = document.getElementById('custom-fields');
            const foodNameInput = document.querySelector('input[name="food_name"]');
            
            if (templateId === 'custom') {
                customFields.style.display = 'block';
                if (foodNameInput.value === '') {
                    foodNameInput.value = '';
                }
            } else {
                customFields.style.display = 'none';
                const template = templateData[templateId];
                if (template) {
                    foodNameInput.value = template.name;
                    // å¦‚æœæ˜¾ç¤ºè‡ªå®šä¹‰å­—æ®µï¼Œä¹Ÿè®¾ç½®å®ƒä»¬çš„å€¼
                    document.querySelector('input[name="carb_ratio"]').value = template.carb_ratio;
                    document.querySelector('input[name="protein_ratio"]').value = template.protein_ratio;
                    document.querySelector('input[name="fat_ratio"]').value = template.fat_ratio;
                }
            }
        }
        
        // è‡ªåŠ¨æ›´æ–°è¿›åº¦ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
        let autoUpdate = true;
        
        function updateProgress() {
            if (!autoUpdate) return;
            
            fetch('/api/progress')
                .then(response => response.json())
                .then(data => {
                    for (const [nutrient, info] of Object.entries(data)) {
                        const fill = document.querySelector(`.${nutrient}-fill`);
                        const text = document.querySelector(`.${nutrient}-fill .progress-text`);
                        
                        if (fill && text) {
                            const percentage = Math.min(info.percentage, 100);
                            fill.style.width = percentage + '%';
                            text.textContent = percentage.toFixed(1) + '%';
                            
                            // æ›´æ–°é¢œè‰²ï¼ˆå¦‚æœè¶…æ ‡ï¼‰
                            if (info.is_over) {
                                fill.classList.add('over-fill');
                            } else {
                                fill.classList.remove('over-fill');
                            }
                            
                            // æ›´æ–°æ–‡æœ¬ä¿¡æ¯
                            const infoDiv = fill.closest('.stat-card').querySelector('.nutrient-info');
                            if (infoDiv) {
                                const consumedSpan = infoDiv.querySelector('div:nth-child(1)');
                                const remainingSpan = infoDiv.querySelector('div:nth-child(3)');
                                
                                if (consumedSpan) {
                                    consumedSpan.textContent = `å·²æ‘„å…¥: ${info.consumed.toFixed(1)}g`;
                                }
                                
                                if (remainingSpan) {
                                    if (info.remaining > 0) {
                                        remainingSpan.textContent = `å‰©ä½™: ${info.remaining.toFixed(1)}g`;
                                    } else {
                                        remainingSpan.textContent = `è¶…æ ‡: ${(-info.remaining).toFixed(1)}g`;
                                    }
                                }
                            }
                        }
                    }
                })
                .catch(error => console.error('æ›´æ–°è¿›åº¦å¤±è´¥:', error));
        }
        
        // æ¯30ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦
        if (autoUpdate) {
            setInterval(updateProgress, 30000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ¨¡æ¿é€‰æ‹©
            const templateSelect = document.querySelector('select[name="template_id"]');
            if (templateSelect) {
                loadTemplate(templateSelect);
            }
        });
    </script>
</body>
</html>